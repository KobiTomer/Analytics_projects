CREATE DATABASE SmokeBan;

טוען את קובץ האקסל עם הנתונים
מקבל מלא שורות כפולות, כנראה ניפחו ככה את האקסל
Row_Number() ממספרת שורה לפי תנאים, ככה רואים כמה כפולים יש

-- יוצר view 
-- שמראה רק שורה יחידה ולא שורות כפולות זהות

Create view SmokersDis AS 
With RowIdCTE AS (
Select *,
	Row_Number() Over(
	Partition By id,
				 smoker,
				 ban, 
				 age, 
				 education, 
				 afam, 
				 hispanic, 
				 gender
				 Order By 
				 id
				 ) row_id
From SmokeBan.dbo.SmokeBan
)
Select *
From RowIdCTE
Where row_id=1
--order by id


Select *
From SmokersDis
order by id

נשאר עם 10,000 שורות ואפשר לעבוד עם זה בעזרת
SmokersDis


די למצוא חציון גיל של גברים או נשים צריך לעשות טבלאות נפרדות בשביל החישוב, כי אין פונקציה ישירה לחציון. 

עושה קודם View נפרד לנשים ונפרד לגברים.
Create view SmokersDisF AS 
With RowIdFCTE AS (
Select *,
	Row_Number() over (order by age) row_idF
From SmokersDis
where Gender='Female'
)
Select *
From RowIdFCTE



Create view SmokersDisM AS 
With RowIdMCTE AS (
Select *,
	Row_Number() over (order by age) row_idM
From SmokersDis
where Gender='Male'
)
Select *
From RowIdMCTE

עכשיו עושה את חישובי החציון בנפרד, קודם לנשים ואז גברים. ההבדל באות M/F
זה בעצם לוקח את הגיל המקסימלי מה50% העליונים של הגיל כשהטבלה מסודרת לפי מספר סידורי עולה (זה בעצם החצי התחתון. לוקחים את המספר האחרון לפי שעוברים לחצי השני), 
מוסיפים לזה את הגיל המינימלי מה50% העליונים של הגיל כשהטבלה מסודרת לפי מספר סידורי יורד (זה בעצם החצי העליון. לוקחים את המספר האחרון לפי שעוברים לחצי הראשון),
כלומר לוקחים את שני המספרים שבדיוק באמצע, מחברים אותם, ואז מחלקים ב2.
SELECT ( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDisF ORDER BY row_idF) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDisF ORDER BY row_idF DESC) AS TOPHALF) ) / 2 AS MEDIAN_F


SELECT ( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDisM ORDER BY row_idM) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDisM ORDER BY row_idM DESC) AS TOPHALF) ) / 2 AS MEDIAN_M


מציגים אחוזים עם הפורמט כשהמספר ליד p קובע כמה מספרים אחרי הנקודה העשרונית
SELECT FORMAT((1.0/5.0),'P3') as [ThreeDecimalsPercentage]


עושה View של MEDIAN_Smokers_race
חציון הגיל של מעשנים, חציון מעשנים שחורים, היספנים, לבנים
Create view MEDIAN_Smokers_race AS
SELECT 
( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_Smokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and afam='yes' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and afam='yes' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_B_Smokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and hispanic='yes' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and hispanic='yes' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_H_Smokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and hispanic='no' and afam='no' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and hispanic='no' and afam='no' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_W_Smokers


עושה View של MEDIAN_Smokers_race_gender
חציון הגיל של מעשנים, חציון מעשנים שחורים, היספנים, לבנים לפי מין גבר ואישה

Create view MEDIAN_Smokers_race_gender AS
SELECT 
( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and gender='Male' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and gender='Male' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_MSmokers,

					( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and gender='Female' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and gender='Female' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_FSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and afam='yes' and gender='Male' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and afam='yes' and gender='Male' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_B_MSmokers,

					( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and afam='yes' and gender='Female' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and afam='yes' and gender='Female' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_B_FSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and hispanic='yes' and gender='Male' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and hispanic='yes'and gender='Male' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_H_MSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and hispanic='yes' and gender='Female' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and hispanic='yes'and gender='Female' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_H_FSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and hispanic='no' and afam='no' and gender='Male' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and hispanic='no' and afam='no' and gender='Male' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_W_MSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='yes' and hispanic='no' and afam='no' and gender='Female' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='yes' and hispanic='no' and afam='no' and gender='Female' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_W_FSmokers

עושה View של MEDIAN_NotSmokers_race_gender
חציון הגיל של לא מעשנים, חציון לא מעשנים שחורים, היספנים, לבנים לפי מין גבר ואישה

Create view MEDIAN_NotSmokers_race_gender AS
SELECT 
( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='no' and gender='Male' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='no' and gender='Male' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_MNotSmokers,

					( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='no' and gender='Female' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='no' and gender='Female' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_FNotSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='no' and afam='yes' and gender='Male' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='no' and afam='yes' and gender='Male' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_B_MNotSmokers,

					( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='no' and afam='yes' and gender='Female' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='no' and afam='yes' and gender='Female' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_B_FNotSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='no' and hispanic='yes' and gender='Male' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='no' and hispanic='yes'and gender='Male' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_H_MNotSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='no' and hispanic='yes' and gender='Female' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='no' and hispanic='yes'and gender='Female' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_H_FNotSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='no' and hispanic='no' and afam='no' and gender='Male' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='no' and hispanic='no' and afam='no' and gender='Male' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_W_MNotSmokers,

( (SELECT MAX(age)
          FROM   (SELECT TOP 50 PERCENT age  
                  FROM SmokersDis Where smoker='no' and hispanic='no' and afam='no' and gender='Female' ORDER BY row_id) AS BOTTOM_HALF)
         + (SELECT MIN(age)
            FROM   (SELECT TOP 50 PERCENT age
                    FROM SmokersDis Where smoker='no' and hispanic='no' and afam='no' and gender='Female' ORDER BY row_id DESC) AS TOPHALF) ) / 2 AS MEDIAN_W_FNotSmokers


עושה View של F_M_AfterBan
אישה לא מעשנת אחרי חרם – אחוזים
אישה מעשנת אחרי חרם – אחוזים
גבר לא מעשן אחרי חרם – אחוזים
גבר מעשן אחרי חרם – אחוזים


Create view F_M_AfterBan AS
Select FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and smoker='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='yes' 
group by ban
)*1.0),'P2')
AS WomenNotSmoksAfterBan,
FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and smoker='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='yes' 
group by ban
)*1.0),'P2')
AS WomenSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and smoker='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='yes' 
group by ban
)*1.0),'P2')
AS MenNotSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and smoker='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='yes' 
group by ban
)*1.0),'P2')
AS MenSmoksAfterBan
עושה View של F_M_NoBan
אישה לא מעשנת בלי חרם – אחוזים
אישה מעשנת בלי חרם – אחוזים
גבר לא מעשן בלי חרם – אחוזים
גבר מעשן בלי חרם – אחוזים
Create view F_M_NoBan AS
Select FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='no' and smoker='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='no' 
group by ban
)*1.0),'P2')
AS WomenNotSmoksNoBan,
FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='no' and smoker='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='no' 
group by ban
)*1.0),'P2')
AS WomenSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='no' and smoker='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='no' 
group by ban
)*1.0),'P2')
AS MenNotSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='no' and smoker='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='no' 
group by ban
)*1.0),'P2')
AS MenSmoksNoBan


עושה View של B_F_M_AfterBan
אישה שחורה לא מעשנת אחרי חרם – אחוזים
אישה שחורה מעשנת אחרי חרם – אחוזים
גבר שחור לא מעשן אחרי חרם – אחוזים
גבר שחור מעשן אחרי חרם – אחוזים
Create view B_F_M_AfterBan AS
Select FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and smoker='no' and afam='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and afam='yes'
group by ban
)*1.0),'P2')
AS BWomenNotSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and smoker='yes' and afam='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and afam='yes'
group by ban
)*1.0),'P2')
AS BWomenSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and smoker='no' and afam='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and afam='yes'
group by ban
)*1.0),'P2')
AS BMenNotSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and smoker='yes' and afam='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and afam='yes'
group by ban
)*1.0),'P2')
AS BMenSmoksAfterBan


עושה View של B_F_M_NoBan
אישה שחורה לא מעשנת בלי חרם – אחוזים
אישה שחורה מעשנת בלי חרם – אחוזים
גבר שחור לא מעשן בלי חרם – אחוזים
גבר שחור מעשן בלי חרם – אחוזים

Create view B_F_M_NoBan AS
Select FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='no' and smoker='no' and afam='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='no' and afam='yes'
group by ban
)*1.0),'P2')
AS BWomenNotSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='no' and smoker='yes' and afam='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='no' and afam='yes'
group by ban
)*1.0),'P2')
AS BWomenSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='no' and smoker='no' and afam='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='no' and afam='yes'
group by ban
)*1.0),'P2')
AS BMenNotSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='no' and smoker='yes' and afam='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='no' and afam='yes'
group by ban
)*1.0),'P2')
AS BMenSmoksNoBan



מעשנים לפי רמת השכלה, וספירת אנשים לפי רמת השכלה 


Select education, Count(smoker)AS SmokeNum
From SmokersDis
Where smoker='yes'
Group by education
Order by SmokeNum


Select education, Count(smoker)AS SmokeNum
From SmokersDis
Group by education
Order by SmokeNum
עושה View של SmokeByEducation
שיעור המעשנים לפי רמת השכלה
hs drop out, hs, some college, college, master


Create view SmokeByEducation AS
SELECT FORMAT((
(Select(
Select Count(smoker)
From SmokersDis
Where education='hs drop out' and smoker='yes' 
Group by education
)*1.0)
/
(Select(
Select Count(smoker)
From SmokersDis
Where education='hs drop out'
Group by education
)*1.0)
),'P2') As HsDropOutSmokes,

FORMAT((
(Select(
Select Count(smoker)
From SmokersDis
Where education='hs' and smoker='yes' 
Group by education
)*1.0)
/
(Select(
Select Count(smoker)
From SmokersDis
Where education='hs'
Group by education
)*1.0)
),'P2') As HsSmokes,

FORMAT((
(Select(
Select Count(smoker)
From SmokersDis
Where education='some college' and smoker='yes' 
Group by education
)*1.0)
/
(Select(
Select Count(smoker)
From SmokersDis
Where education='some college'
Group by education
)*1.0)
),'P2') As SomeCollegeSmokes,

FORMAT((
(Select(
Select Count(smoker)
From SmokersDis
Where education='college' and smoker='yes' 
Group by education
)*1.0)
/
(Select(
Select Count(smoker)
From SmokersDis
Where education='college'
Group by education
)*1.0)
),'P2') As CollegeSmokes,

FORMAT((
(Select(
Select Count(smoker)
From SmokersDis
Where education='master' and smoker='yes' 
Group by education
)*1.0)
/
(Select(
Select Count(smoker)
From SmokersDis
Where education='master'
Group by education
)*1.0)
),'P2') As MasterSmokes

עושה View של H_F_M_AfterBan
אישה היספנית לא מעשנת אחרי חרם – אחוזים
אישה היספנית מעשנת אחרי חרם – אחוזים
גבר היספני לא מעשן אחרי חרם – אחוזים
גבר היספני מעשן אחרי חרם – אחוזים

Create view H_F_M_AfterBan AS
Select FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and smoker='no' and hispanic='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and hispanic='yes'
group by ban
)*1.0),'P2')
AS HWomenNotSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and smoker='yes' and hispanic='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and hispanic='yes'
group by ban
)*1.0),'P2')
AS HWomenSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and smoker='no' and hispanic='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and hispanic='yes'
group by ban
)*1.0),'P2')
AS HMenNotSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and smoker='yes' and hispanic='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and hispanic='yes'
group by ban
)*1.0),'P2')
AS HMenSmoksAfterBan

עושה View של H_F_M_NoBan
אישה היספנית לא מעשנת בלי חרם – אחוזים
אישה היספנית מעשנת בלי חרם – אחוזים
גבר היספני לא מעשן בלי חרם – אחוזים
גבר היספני מעשן בלי חרם – אחוזים

Create view H_F_M_NoBan AS
Select FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='no' and smoker='no' and hispanic='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='no' and hispanic='yes'
group by ban
)*1.0),'P2')
AS HWomenNotSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='no' and smoker='yes' and hispanic='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='no' and hispanic='yes'
group by ban
)*1.0),'P2')
AS HWomenSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='no' and smoker='no' and hispanic='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='no' and hispanic='yes'
group by ban
)*1.0),'P2')
AS HMenNotSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='no' and smoker='yes' and hispanic='yes'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='no' and hispanic='yes'
group by ban
)*1.0),'P2')
AS HMenSmoksNoBan


עושה View של W_F_M_AfterBan
אישה לבנה לא מעשנת אחרי חרם – אחוזים
אישה לבנה מעשנת אחרי חרם – אחוזים
גבר לבן לא מעשן אחרי חרם – אחוזים
גבר לבן מעשן אחרי חרם – אחוזים

Create view W_F_M_AfterBan AS
Select FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and smoker='no' and hispanic='no' and afam='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and hispanic='no' and afam='no'
group by ban
)*1.0),'P2')
AS WWomenNotSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and smoker='yes' and hispanic='no' and afam='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='yes' and hispanic='no' and afam='no'
group by ban
)*1.0),'P2')
AS WWomenSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and smoker='no' and hispanic='no' and afam='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and hispanic='no' and afam='no'
group by ban
)*1.0),'P2')
AS WMenNotSmoksAfterBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and smoker='yes' and hispanic='no' and afam='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='yes' and hispanic='no' and afam='no'
group by ban
)*1.0),'P2')
AS WMenSmoksAfterBan

עושה View של W_F_M_NoBan
אישה לבנה לא מעשנת בלי חרם – אחוזים
אישה לבנה מעשנת בלי חרם – אחוזים
גבר לבן לא מעשן בלי חרם – אחוזים
גבר לבן מעשן בלי חרם – אחוזים

Create view W_F_M_NoBan AS
Select FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='no' and smoker='no' and hispanic='no' and afam='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='no' and hispanic='no' and afam='no'
group by ban
)*1.0),'P2')
AS WWomenNotSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisF
Where ban='no' and smoker='yes' and hispanic='no' and afam='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisF
Where ban='no' and hispanic='no' and afam='no'
group by ban
)*1.0),'P2')
AS WWomenSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='no' and smoker='no' and hispanic='no' and afam='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='no' and hispanic='no' and afam='no'
group by ban
)*1.0),'P2')
AS WMenNotSmoksNoBan,

FORMAT(
(Select(
Select Count(id)
From SmokersDisM
Where ban='no' and smoker='yes' and hispanic='no' and afam='no'
)*1.0)
/
(
Select(
Select Count(id)
From SmokersDisM
Where ban='no' and hispanic='no' and afam='no'
group by ban
)*1.0),'P2')
AS WMenSmoksNoBan

סיכום Views

SmokersDis
SmokersDisF
SmokersDisM
MEDIAN_Smokers_race
MEDIAN_Smokers_race_gender
MEDIAN_NotSmokers_race_gender
F_M_AfterBan
F_M_NoBan
B_F_M_AfterBan
B_F_M_NoBan
SmokeByEducation
H_F_M_AfterBan
H_F_M_NoBan
W_F_M_AfterBan
W_F_M_NoBan


